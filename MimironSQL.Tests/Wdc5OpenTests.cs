using MimironSQL.Db2;
using MimironSQL.Db2.Wdc5;
using MimironSQL.Providers;

using Shouldly;

namespace MimironSQL.Tests;

public sealed class Wdc5OpenTests
{
    [Fact]
    public void Detects_wdc5_from_header_bytes()
    {
        var db2Provider = new FileSystemDb2StreamProvider(new(TestDataPaths.GetTestDataDirectory()));
        using var stream = db2Provider.OpenDb2Stream("Map");
        Span<byte> header = stackalloc byte[4];
        stream.ReadExactly(header);

        Db2FormatDetector.DetectOrThrow(header).ShouldBe(Db2Format.Wdc5);
    }

    [Fact]
    public void Opens_map_db2_and_parses_header_invariants()
    {
        var db2Provider = new FileSystemDb2StreamProvider(new(TestDataPaths.GetTestDataDirectory()));
        using var stream = db2Provider.OpenDb2Stream("Map");
        var file = new Wdc5File(stream);
        file.Header.RecordsCount.ShouldBeGreaterThan(0);
        file.Header.FieldsCount.ShouldBeGreaterThan(0);
        file.Header.RecordSize.ShouldBeGreaterThan(0);
        file.Header.SectionsCount.ShouldBeGreaterThanOrEqualTo(0);
        file.FieldMeta.Length.ShouldBe(file.Header.FieldsCount);
        file.ColumnMeta.Length.ShouldBe(file.Header.FieldsCount);

        file.TotalSectionRecordCount.ShouldBe(file.Header.RecordsCount);
    }

    [Fact]
    public void Opens_spell_db2_and_parses_header_invariants()
    {
        var db2Provider = new FileSystemDb2StreamProvider(new(TestDataPaths.GetTestDataDirectory()));
        using var stream = db2Provider.OpenDb2Stream("Spell");
        var file = new Wdc5File(stream);
        file.Header.RecordsCount.ShouldBeGreaterThan(0);
        file.Header.FieldsCount.ShouldBeGreaterThan(0);
        file.Header.RecordSize.ShouldBeGreaterThan(0);
        file.FieldMeta.Length.ShouldBe(file.Header.FieldsCount);
        file.ColumnMeta.Length.ShouldBe(file.Header.FieldsCount);

        file.Sections.Any(s => s.TactKeyLookup != 0).ShouldBeTrue();
        file.TotalSectionRecordCount.ShouldBeGreaterThan(0);
        file.TotalSectionRecordCount.ShouldBeLessThan(file.Header.RecordsCount);
    }
}
