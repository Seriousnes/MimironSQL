using MimironSQL.Db2;
using MimironSQL.Db2.Wdc5;
using Shouldly;
using Xunit;

namespace MimironSQL.Tests;

public sealed class Wdc5OpenTests
{
    [Fact]
    public void Detects_wdc5_from_header_bytes()
    {
        using var stream = TestDataPaths.OpenMapDb2();
        Span<byte> header = stackalloc byte[4];
        stream.ReadExactly(header);

        Db2FormatDetector.DetectOrThrow(header).ShouldBe(Db2Format.Wdc5);
    }

    [Fact]
    public void Opens_map_db2_and_parses_header_invariants()
    {
        using var stream = TestDataPaths.OpenMapDb2();
        var file = new Wdc5File(stream);
        file.Header.RecordsCount.ShouldBeGreaterThan(0);
        file.Header.FieldsCount.ShouldBeGreaterThan(0);
        file.Header.RecordSize.ShouldBeGreaterThan(0);
        file.Header.SectionsCount.ShouldBeGreaterThanOrEqualTo(0);
        file.FieldMeta.Length.ShouldBe(file.Header.FieldsCount);
        file.ColumnMeta.Length.ShouldBe(file.Header.FieldsCount);

        file.TotalSectionRecordCount.ShouldBe(file.Header.RecordsCount);
    }

    [Fact]
    public void Opens_spell_db2_and_parses_header_invariants()
    {
        using var stream = TestDataPaths.OpenSpellDb2();
        var file = new Wdc5File(stream);
        file.Header.RecordsCount.ShouldBeGreaterThan(0);
        file.Header.FieldsCount.ShouldBeGreaterThan(0);
        file.Header.RecordSize.ShouldBeGreaterThan(0);
        file.FieldMeta.Length.ShouldBe(file.Header.FieldsCount);
        file.ColumnMeta.Length.ShouldBe(file.Header.FieldsCount);

        file.TotalSectionRecordCount.ShouldBe(file.Header.RecordsCount);
    }
}
